<html>
    <body>
        <div style="text-align:center;">
            <div style="margin-top: 20%">
                <img src="kbase_animated_logo.gif" ></img>
                <div id="text" style="font-size:146.5%; color:#006698; font-family:'OxygenBold', Arial, sans-serif">
                    <br>
                    Loading your Narrative
                    <br>
                    Please wait...
                </div>
            </div>
        </div>
    </body>

    <script src="jquery-1.10.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script>
        (function( $, undefined ) {
            var maxTries = 30;
            var stateFlag = 0;
            var retryTime = 500; //ms
            var numTries = 0;
            var narrUrl = window.location.href.slice(window.location.href.indexOf('?') + 1);
            narrUrl = narrUrl.split('=')[1];

            var interval = null;
            var pokeNarrative = function(url) {
                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function(res) {
                        // on success, take us there!
                        window.location.replace(url);
                    },
                    error: function(error) {
                        // look at error. if it's a 500, probably not allowed to see it (parse error and try)
                        // otherwise, keep trying!
                        if(error.status === 500) {
                            if (interval)
                                clearInterval(interval);
                            $('#text').html('<br>Sorry, it looks like you don\'t have permission to view that Narrative.<br>If you see this error after coming through an outside link, <br>please try to access this Narrative through the main site <a href="/">here</a>.');
                        }
                        numTries++;
                    },
                });
            };

            if (narrUrl) {
                interval = setInterval( function() { 
                    pokeNarrative(narrUrl); 
                    if (numTries > maxTries/2 && stateFlag === 0) {
                        $('#text').html('<br>Sorry, this is taking longer than expected.<br>Please be patient.');
                        stateFlag++;
                    }
                    if (numTries > maxTries && stateFlag === 1) {
                        $('#text').html('<br>Sorry, it appears an error occurred while setting up your narrative.<br>Please try again later, or look <a href="//kbase.us/user-support/report-issue/">Here</a> for some help!');
                        stateFlag++;
                        clearInterval(interval);
                    }
                }, retryTime );
            }
        })(jQuery);        
    </script>
</html>